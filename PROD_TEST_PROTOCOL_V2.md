# Протокол Тестирования Production-Среды (Версия 2.0)

**Проект:** N8N AI Starter Kit
**Дата:** 1 сентября 2025 г.
**Цель:** Формальная верификация релиза перед полной передачей в эксплуатацию.

---

## Общие Принципы

- **Идемпотентность**: Каждый шаг должен быть по возможности идемпотентным или иметь четкие инструкции по повторному выполнению.
- **Атомарность**: Каждый пункт чеклиста проверяет один конкретный аспект системы.
- **Документирование**: Результат каждого шага (Pass/Fail/N/A) должен быть задокументирован исполнителем.

---

## Фаза 0: Подготовка к развертыванию (Pre-Flight)

| ID   | Действие                                                                                         | Статус (Pass/Fail) | Комментарий |
| ---- | ------------------------------------------------------------------------------------------------ | ------------------ | ----------- |
| P-01 | Созданы полные резервные копии всех stateful-сервисов (Postgres, Qdrant, volumes).               |                    |             |
| P-02 | Резервные копии проверены на целостность и доступность для восстановления.                       |                    |             |
| P-03 | Конфигурационный файл `.env` проверен и содержит все необходимые переменные для нового релиза.   |                    |             |
| P-04 | Команда, ответственная за развертывание, имеет все необходимые доступы (SSH, Docker, CI/CD).     |                    |             |
| P-05 | Канал коммуникации для информирования о ходе развертывания определен и все участники приглашены. |                    |             |

---

## Фаза 1: Развертывание (Deployment)

| ID   | Действие                                                                               | Статус (Pass/Fail) | Комментарий |
| ---- | -------------------------------------------------------------------------------------- | ------------------ | ----------- |
| D-01 | Активирован режим "техобслуживания" (maintenance mode) через Traefik (если применимо). |                    |             |
| D-02 | Запущена процедура развертывания (например, `docker compose up -d` с нужным профилем). |                    |             |
| D-03 | Процесс развертывания завершился без ошибок в CI/CD или консоли.                       |                    |             |
| D-04 | Режим "техобслуживания" отключен.                                                      |                    |             |

---

## Фаза 2: Проверка работоспособности системы (System Health Check)

| ID   | Действие                                                                                                            | Статус (Pass/Fail) | Комментарий |
| ---- | ------------------------------------------------------------------------------------------------------------------- | ------------------ | ----------- |
| H-01 | Все контейнеры, определенные в профиле, находятся в состоянии `running` или `healthy`. (`docker ps`)                |                    |             |
| H-02 | В логах ключевых сервисов (n8n, Traefik, Postgres, Ollama) отсутствуют критические ошибки (fatal, error) на старте. |                    |             |
| H-03 | Dashboard Traefik доступен и показывает все ожидаемые роутеры и сервисы.                                            |                    |             |
| H-04 | Основной эндпоинт `n8n` (`https://n8n.${DOMAIN_NAME}`) отвечает с кодом 200/302.                                    |                    |             |

---

## Фаза 3: Функциональное тестирование (Functional Validation)

| ID   | Действие                                                                                                        | Статус (Pass/Fail) | Комментарий |
| ---- | --------------------------------------------------------------------------------------------------------------- | ------------------ | ----------- |
| F-01 | Аутентификация в `n8n` (UI) работает для пользователя-администратора.                                           |                    |             |
| F-02 | Тестовый workflow (не использующий внешние интеграции) успешно создается и выполняется в `n8n`.                 |                    |             |
| F-03 | Тестовый workflow, использующий Postgres, успешно выполняется.                                                  |                    |             |
| F-04 | API сервиса `LightRAG` доступен и отвечает на тестовый запрос (query).                                          |                    |             |
| F-05 | RAG-пайплайн: тестовый запрос к `LightRAG` возвращает релевантный результат из `Qdrant`, обработанный `Ollama`. |                    |             |
| F-06 | Создание/чтение учетных данных (credentials) в `n8n` работает корректно.                                        |                    |             |

---

## Фаза 4: Проверка интеграций и мониторинга (Integration & Monitoring)

| ID   | Действие                                                                                    | Статус (Pass/Fail) | Комментарий |
| ---- | ------------------------------------------------------------------------------------------- | ------------------ | ----------- |
| M-01 | Prometheus успешно собирает метрики со всех настроенных `targets`. Все цели в статусе `UP`. |                    |             |
| M-02 | Дашборды в Grafana доступны и отображают актуальные данные без ошибок.                      |                    |             |
| M-03 | Система алертов (Alertmanager) сконфигурирована и тестовый алерт успешно проходит.          |                    |             |
| M-04 | Логи из контейнеров успешно поступают в систему сбора логов (ELK/Loki).                     |                    |             |

---

## Фаза 5: Аудит безопасности (Security Audit)

| ID   | Действие                                                                                             | Статус (Pass/Fail) | Комментарий |
| ---- | ---------------------------------------------------------------------------------------------------- | ------------------ | ----------- |
| S-01 | Все публичные эндпоинты работают через HTTPS с валидным TLS-сертификатом.                            |                    |             |
| S-02 | Эндпоинты, требующие аутентификации (Traefik dashboard, pgAdmin, кастомные API), недоступны без нее. |                    |             |
| S-03 | Проверка HTTP-заголовков на публичных эндпоинтах (Security Headers) соответствует стандартам.        |                    |             |
| S-04 | В репозитории и в переменных окружения контейнеров отсутствуют незашифрованные секреты.              |                    |             |

---

## Фаза 6: Финальное утверждение (Final Sign-off)

| Роль            | ФИО | Подпись | Дата |
| --------------- | --- | ------- | ---- |
| Release Manager |     |         |      |
| QA Lead         |     |         |      |
| DevOps Lead     |     |         |      |

**Решение:** Релиз утвержден / Отклонен

---

## План отката (Contingency Plan)

В случае провала критического шага (любой шаг из Фазы 2 или F-01, F-04) немедленно инициируется процедура отката:

1.  **Активация режима "техобслуживания"**.
2.  **Остановка текущей версии стека** (`docker compose down`).
3.  **Восстановление данных** из резервных копий, созданных на шаге P-01.
4.  **Развертывание предыдущей стабильной версии** (откат коммита и запуск `docker compose up`).
5.  **Проведение сокращенного Health Check** (Фаза 2) для проверки работоспособности восстановленной системы.
6.  **Отключение режима "техобслуживания"**.
7.  **Начало анализа причин сбоя (post-mortem)**.
