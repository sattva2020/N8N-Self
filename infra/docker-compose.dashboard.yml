version: '3.8'
services:
  keycloak:
    image: quay.io/keycloak/keycloak:21.1.3
    command: ["start-dev"]
    environment:
      - KEYCLOAK_ADMIN=admin
      - KEYCLOAK_ADMIN_PASSWORD=admin
    ports:
      - "8081:8080"
    volumes:
      - keycloak_data:/opt/keycloak/data

  oauth2-proxy:
    image: quay.io/oauth2-proxy/oauth2-proxy:latest
    environment:
      - OAUTH2_PROXY_PROVIDER=oidc
      - OAUTH2_PROXY_OIDC_ISSUER_URL=http://keycloak:8080/realms/dashboard
      - OAUTH2_PROXY_CLIENT_ID=dashboard-client
      - OAUTH2_PROXY_CLIENT_SECRET=change_me
      - OAUTH2_PROXY_COOKIE_SECRET=change_me_cookie
      - OAUTH2_PROXY_EMAIL_DOMAINS=*
      - OAUTH2_PROXY_UPSTREAMS=http://dashboard-backend:3000/
      - OAUTH2_PROXY_HTTP_ADDRESS=0.0.0.0:4180
      - OAUTH2_PROXY_REDIRECT_URL=https://dashboard.${DOMAIN_NAME}/oauth2/callback
      - OAUTH2_PROXY_LOGIN_URL=http://keycloak:8080/realms/dashboard/protocol/openid-connect/auth
      - OAUTH2_PROXY_REDEEM_URL=http://keycloak:8080/realms/dashboard/protocol/openid-connect/token
      - OAUTH2_PROXY_VALIDATE_URL=http://keycloak:8080/realms/dashboard/protocol/openid-connect/userinfo
    ports:
      - "4180:4180"
    depends_on:
      - keycloak
    networks:
      - proxy
      - backend

  dashboard-backend:
    build: ../dashboard/backend
    image: dashboard-backend:local
    environment:
      - NODE_ENV=development
      - POLL_INTERVAL=15
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - backend
      - proxy
    labels:
      - traefik.enable=true
      - traefik.docker.network=stack_proxy
      - traefik.http.routers.dashboard-backend.rule=Host(`dashboard.${DOMAIN_NAME}`)
      - traefik.http.routers.dashboard-backend.entrypoints=websecure
      - traefik.http.routers.dashboard-backend.tls.certresolver=le
      - traefik.http.routers.dashboard-backend.middlewares=oauth2-proxy@docker

  dashboard-frontend:
    build: ../dashboard/frontend
    image: dashboard-frontend:local
    networks:
      - proxy
    labels:
      - traefik.enable=true
      - traefik.docker.network=stack_proxy
      - traefik.http.routers.dashboard.rule=Host(`dashboard.${DOMAIN_NAME}`)
      - traefik.http.routers.dashboard.entrypoints=websecure
      - traefik.http.routers.dashboard.tls.certresolver=le
      - traefik.http.routers.dashboard.middlewares=oauth2-proxy@docker

networks:
  proxy:
    external: true
  backend:
    external: false

volumes:
  keycloak_data:
